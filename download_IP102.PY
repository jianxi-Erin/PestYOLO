import gdown
import os
import tarfile
import subprocess

def download_and_extract_dataset():
    # æ•°æ®é›†ä¿å­˜è·¯å¾„
    root = "/IP102_v1.1"

    # Google Drive æ–‡ä»¶å¤¹é“¾æ¥
    folder_url = "https://drive.google.com/drive/folders/1svFSy2Da3cVMvekBwe13mzyx38XZ9xWo"

    # åˆ¤æ–­æ•°æ®é›†æ˜¯å¦å·²ç»å­˜åœ¨
    if os.path.exists(root) and os.listdir(root):
        print(f"æ•°æ®é›†å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½è§£å‹: {root}")
        return

    print(f"å¼€å§‹ä¸‹è½½æ•°æ®é›†åˆ°: {root}")
    
    # ä½¿ç”¨gdownä¸‹è½½æ–‡ä»¶å¤¹
    try:
        # æ–¹æ³•1: ä½¿ç”¨gdownçš„Python API
        gdown.download_folder(url=folder_url, output=root, quiet=False)
    except Exception as e:
        print(f"ä½¿ç”¨Python APIä¸‹è½½å¤±è´¥: {e}")
        print("å°è¯•ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼ä¸‹è½½...")
        # æ–¹æ³•2: ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼
        try:
            result = subprocess.run([
                'gdown', '--folder', folder_url, '-O', root
            ], capture_output=True, text=True)
            if result.returncode != 0:
                print(f"å‘½ä»¤è¡Œä¸‹è½½å¤±è´¥: {result.stderr}")
                return
        except Exception as e:
            print(f"å‘½ä»¤è¡Œæ–¹å¼ä¹Ÿå¤±è´¥äº†: {e}")
            return

    print("----å¼€å§‹è§£å‹æ•°æ®é›†----")

    # å‹ç¼©åŒ…åˆ—è¡¨
    tar_files = [
        os.path.join(root, "Classification/ip102_v1.1.tar"),
        os.path.join(root, "Detection/VOC2007/Annotations.tar"),
        os.path.join(root, "Detection/VOC2007/JPEGImages.tar")
    ]

    # è§£å‹å‡½æ•°
    def extract_tar(tar_path, output_dir=None):
        if output_dir is None:
            output_dir = os.path.dirname(tar_path)
        
        # æ£€æŸ¥taræ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(tar_path):
            print(f"âŒ å‹ç¼©æ–‡ä»¶ä¸å­˜åœ¨: {tar_path}")
            return False
            
        print(f"è§£å‹: {tar_path} â†’ {output_dir}")
        try:
            with tarfile.open(tar_path, "r") as tar:
                tar.extractall(path=output_dir)
            print(f"âœ… å®Œæˆ: {tar_path}")
            return True
        except Exception as e:
            print(f"âŒ è§£å‹å¤±è´¥ {tar_path}: {e}")
            return False

    # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
    required_dirs = [
        os.path.join(root, "Classification"),
        os.path.join(root, "Detection/VOC2007")
    ]
    
    for dir_path in required_dirs:
        os.makedirs(dir_path, exist_ok=True)

    # éå†è§£å‹
    success_count = 0
    for tar_file in tar_files:
        if extract_tar(tar_file):
            success_count += 1

    print(f"\nè§£å‹å®Œæˆ: {success_count}/{len(tar_files)} ä¸ªæ–‡ä»¶æˆåŠŸè§£å‹")
    
    # æ£€æŸ¥æœ€ç»ˆç›®å½•ç»“æ„
    print("\næ•°æ®é›†ç»“æ„æ£€æŸ¥:")
    check_dirs = [
        root,
        os.path.join(root, "Classification"),
        os.path.join(root, "Detection"),
        os.path.join(root, "Detection/VOC2007")
    ]
    
    for check_dir in check_dirs:
        if os.path.exists(check_dir):
            file_count = len([f for f in os.listdir(check_dir) if os.path.isfile(os.path.join(check_dir, f))])
            dir_count = len([d for d in os.listdir(check_dir) if os.path.isdir(os.path.join(check_dir, d))])
            print(f"ğŸ“ {check_dir}: {file_count} ä¸ªæ–‡ä»¶, {dir_count} ä¸ªå­ç›®å½•")
        else:
            print(f"âŒ ç›®å½•ä¸å­˜åœ¨: {check_dir}")

if __name__ == "__main__":
    download_and_extract_dataset()